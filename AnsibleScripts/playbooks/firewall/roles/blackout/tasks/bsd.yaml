- name: Load firewall if not loaded
  ansible.builtin.shell: kldload pf
  ignore_errors: true

- name: Check if in domain
  ansible.builtin.shell: command -v adcli
  ignore_errors: true
  register: adcli

- name: Add dc config to rc.conf
  when: adcli.rc == 0
  ansible.builtin.shell: |
    sysrc pf_enable="yes"
    sysrc pf_rules="/root/dc_blackout.conf"

- name: Add config to rc.conf
  when: not adcli.rc == 0
  ansible.builtin.shell: |
    sysrc pf_enable="yes"
    sysrc pf_rules="/root/blackout.conf"

- name: Add dc_blackout.conf if in domain
  when: adcli.rc == 0
  ansible.builtin.template:
    dest: /root/dc_blackout.conf
    src: dc_blackout.j2

- name: Add blackout.conf if not in domain
  when: not adcli.rc == 0
  ansible.builtin.template:
    dest: /root/blackout.conf
    src: blackout.j2

- name: Start pf
  ignore_unreachable: true
  ansible.builtin.service:
    name: pf
    state: started
